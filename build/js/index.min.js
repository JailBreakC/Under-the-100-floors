var gameController={_animation:null,_canvasWidth:0,_canvasHeight:0,_floorWidth:0,_floorHeight:0,_floorDeltaY:50,_floorScore:1,_speed:50,_maxSpeed:350,_blood:12,_$canvas:$(".game-canvas"),_$scroller:$(".scroller"),_$people:$(".people"),_peopleSpeed:180,_peopleRotateZ:0,_peopleRotateDelta:25,_peopleVerticalSpeed:200,_peopleHeight:0,_peopleWidth:0,__currentScrollerY:0,__currentPeopleY:20,__currentPeopleVertical:0,__floorScrollerY:200,__maxJumpDistance:20,__currentJumpDistance:0,__frameIndex:0,gameover:function(){this.stop(),setTimeout(function(){$("#game-ct").hide(),$(".game-over").show()}.bind(this),200),_czc.push(["_trackEvent","score","game","gameover",this._floorScore])},createFloorSpan:function(){var e=this.__floorScrollerY+=this._floorDeltaY,t=Math.random()*(this._canvasWidth-this._floorWidth),o=['<i class="floor normal"></i>','<i class="floor normal"></i>','<i class="floor spring"></i>','<i class="floor spring"></i>','<i class="floor weak"></i>','<i class="floor weak"></i>','<i class="floor scroll-left"></i>','<i class="floor scroll-right"></i>','<i class="floor nail"></i>','<i class="floor nail"></i>','<i class="floor nail"></i>','<i class="floor nail"></i>'];$(o[Math.floor(Math.random()*o.length)]).css({top:e,left:t,width:this._floorWidth,height:this._floorHeight}).appendTo(this._$scroller)},removeFloorSpan:function(){$(".floor").eq(0).remove(),this._floorScore++,this.updateScore()},updateBlood:function(){for(var e=$(".blood i"),t=0;t<e.length;t++)t<this._blood?e.eq(t).removeClass("lose"):e.eq(t).addClass("lose")},updateScore:function(){$(".text-score").text(this._floorScore)},loseBlood:function(){if(!this.__onFloor)return this._blood-=4,this._$people.addClass("danger"),setTimeout(function(){this._$people.removeClass("danger")}.bind(this),1e3),$("#game-ct").addClass("danger"),setTimeout(function(){$("#game-ct").removeClass("danger")},100),this._blood<=0?(this._blood=0,this.updateBlood(),void this.gameover()):void this.updateBlood()},addBlood:function(){this.__onFloor||this._blood>=12||(this._blood+=1,this.updateBlood())},floorNormal:function(){this.addBlood()},floorNail:function(){this.loseBlood()},floorWeak:function(e){this.addBlood(),setTimeout(function(){e.addClass("over"),e[0].cross=!0},200)},floorScroll:function(e){this.addBlood(),this.__floorScrollDirection=e},floorScrollEnd:function(){this.__floorScrollDirection=null},floorSpring:function(e){this.__$currentJumpFloor=e,this.jumpStart(),this.addBlood()},jumpStart:function(){this.__jumpMode=!0,this.__$currentJumpFloor.addClass("up"),setTimeout(function(){this.__$currentJumpFloor.removeClass("up")}.bind(this),200),this.__tempPeopleSpeed=this._peopleSpeed,this._peopleSpeed=this._peopleSpeed/2},jumpEnd:function(e){this.__jumpMode&&(e&&(this.__$currentJumpFloor[0].cross=!0),this.__currentJumpDistance=0,this.__jumpMode=!1,this._peopleSpeed=this.__tempPeopleSpeed)},people:function(e){var t=this._peopleSpeed/e,o=this._speed/e,r=this._peopleVerticalSpeed/e,s=$(".floor"),l=this._$people.offset();if(l.top>this._canvasHeight)return void this.gameover();for(i=0;i<s.length;i++){var a=s.eq(i).offset(),n=Math.abs(l.top+this._peopleHeight-a.top);if(l.top<=t+o){this.__onFloor=!1,this.jumpEnd(!0),this.loseBlood();break}if(!this.__jumpMode&&!s.eq(i)[0].cross&&n<=t+o&&l.left>a.left-this._peopleWidth&&l.left<a.left+this._floorWidth){this.__currentPeopleY=a.top-this._peopleHeight,s.eq(i).hasClass("normal")&&this.floorNormal(),s.eq(i).hasClass("nail")&&this.floorNail(),s.eq(i).hasClass("spring")&&this.floorSpring(s.eq(i)),s.eq(i).hasClass("weak")&&this.floorWeak(s.eq(i)),s.eq(i).hasClass("scroll-left")&&this.floorScroll("left"),s.eq(i).hasClass("scroll-right")&&this.floorScroll("right"),this.__onFloor=!0;break}i==s.length-1&&(this.__onFloor=!1)}this.__jumpMode&&(this.__currentJumpDistance>=this.__maxJumpDistance?this.jumpEnd():(this.__currentJumpDistance+=t,this.__currentPeopleY-=t+o)),this.__onFloor||this.__jumpMode||(this.floorScrollEnd(),this.__currentPeopleY+=t);var h=r;this._peopleGoLeft&&("left"==this.__floorScrollDirection&&(h*=1.5),"right"==this.__floorScrollDirection&&(h*=.5),this.__currentPeopleVertical>0&&(this.__currentPeopleVertical-=h)),this._peopleGoRight&&("left"==this.__floorScrollDirection&&(h*=.5),"right"==this.__floorScrollDirection&&(h*=1.5),this.__currentPeopleVertical<this._canvasWidth-this._peopleWidth&&(this.__currentPeopleVertical+=h)),this._peopleGoRight||this._peopleGoLeft||(h*=.5,"left"==this.__floorScrollDirection&&this.__currentPeopleVertical>0&&(this.__currentPeopleVertical-=h),"right"==this.__floorScrollDirection&&this.__currentPeopleVertical<this._canvasWidth-this._peopleWidth&&(this.__currentPeopleVertical+=h)),this.peopleUpdateView()},floorUpdateView:function(){Modernizr.csstransforms3d?this._$scroller.css({"-webkit-transform":"translate3d(0, "+this.__currentScrollerY+"px, 0)","-ms-transform":"translate3d(0, "+this.__currentScrollerY+"px, 0)",transform:"translate3d(0, "+this.__currentScrollerY+"px, 0)"}):Modernizr.csstransforms?this._$scroller.css({"-webkit-transform":"translateY("+this.__currentScrollerY+"px)","-ms-transform":"translateY("+this.__currentScrollerY+"px)",transform:"translateY("+this.__currentScrollerY+"px)"}):this._$scroller.css({top:this.__currentScrollerY+"px"})},peopleUpdateView:function(){this.__onFloor&&(this._peopleGoLeft&&(this._peopleRotateZ-=this._peopleRotateDelta),this._peopleGoRight&&(this._peopleRotateZ+=this._peopleRotateDelta)),Modernizr.csstransforms3d?this._$people.css({"-webkit-transform":"translate3d("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px ,0) rotateZ("+this._peopleRotateZ+"deg)","-ms-transform":"translate3d("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px ,0) rotateZ("+this._peopleRotateZ+"deg)",transform:"translate3d("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px ,0) rotateZ("+this._peopleRotateZ+"deg)"}):Modernizr.csstransforms?this._$people.css({"-webkit-transform":"translate("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px) rotateZ("+this._peopleRotateZ+"deg)","-ms-transform":"translate("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px) rotateZ("+this._peopleRotateZ+"deg)",transform:"translate("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px) rotateZ("+this._peopleRotateZ+"deg)"}):this._$people.css({left:this.__currentPeopleVertical+"px",top:this.__currentPeopleY+"px"})},peopleUserController:function(){var e=this;$(window).keydown(function(t){return"ArrowRight"==t.key?(e._peopleGoRight=!0,void(e._peopleGoLeft=!1)):"ArrowLeft"==t.key?(e._peopleGoRight=!1,void(e._peopleGoLeft=!0)):void 0}).keyup(function(t){return"ArrowRight"==t.key?void(e._peopleGoRight=!1):"ArrowLeft"==t.key?void(e._peopleGoLeft=!1):void 0}),$(".controller .left-ct").on("touchstart",function(t){return e._peopleGoRight=!1,e._peopleGoLeft=!0,!1}).on("touchend",function(t){e._peopleGoLeft=!1}),$(".controller .right-ct").on("touchstart",function(t){return e._peopleGoRight=!0,e._peopleGoLeft=!1,!1}).on("touchend",function(t){e._peopleGoRight=!1})},core:function(e){var t=this._speed/e,o=$(".floor");if(this.__currentScrollerY-=t,this.__currentScrollerY<=2*-this._canvasHeight)for(this.__currentScrollerY+=this._canvasHeight,this.__floorScrollerY-=this._canvasHeight,i=0;i<o.length;i++)o.eq(i).css({top:parseInt($(".floor").eq(i).css("top"))-this._canvasHeight});this.floorUpdateView(),o.eq(0).offset().top<=-20&&(this.createFloorSpan(),this.removeFloorSpan()),this.people(e),this._speed<=this._maxSpeed&&(this._speed+=.05)},run:function(e){if(this._animation)return void console.error("Animation has aready in process, please do not run again!");this._fps=e=e||60;var t=1e3/e,o=this;return this._animation=setInterval(function(){o.core(e)},t)},stop:function(){clearInterval(this._animation),this._animation=void 0},reRun:function(){console.log(this.__paramBackup._floorScore),$.extend(this,this.__paramBackup),$(".floor").remove(),this.init()},backup:function(){this.__paramBackup={};for(i in this)"number"!=typeof this[i]&&"string"!=typeof this[i]||(this.__paramBackup[i]=this[i])},init:function(){var e=0;for(this._canvasWidth=this._$canvas.width(),this._canvasHeight=this._$canvas.height(),this._floorDeltaY=this._canvasHeight/11,this._floorWidth=this._canvasWidth/5,this._floorHeight=this._floorWidth/9,this._peopleHeight=parseInt(this._$people.css("height")),this._peopleWidth=parseInt(this._$people.css("width")),this.__currentPeopleVertical=this._canvasWidth/2+this._peopleWidth/2,this.backup();e++<13;)this.createFloorSpan();this.peopleUserController(),this.peopleUpdateView(),this.updateBlood(),this.updateScore(),this.run(60)}};$(function(){$("#start-game").click(function(){$(".game-intro").hide(),$("#game-ct").show(),gameController.init()}),$("#restart-game").click(function(){$("#game-ct").show(),$(".game-over").hide(),gameController.reRun()});var e=function(){for(var e=["../../public/images/spring-up.png"],t=0;t<e.length;t++){var o=new Image;o.src=e[t]}};e()});