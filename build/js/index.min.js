var gameController={_animation:null,_canvasWidth:0,_canvasHeight:0,_floorWidth:0,_floorHeight:0,_floorDeltaY:50,_floorScore:1,_speed:50,_maxSpeed:250,_blood:12,_$canvas:$(".canvas"),_$scroller:$(".scroller"),_$people:$(".people"),_peopleSpeed:180,_peopleVerticalSpeed:150,_peopleHeight:0,_peopleWidth:0,__currentScrollerY:0,__currentPeopleY:20,__currentPeopleVertical:0,__floorScrollerY:200,__maxJumpDistance:20,__currentJumpDistance:0,__frameIndex:0,gameover:function(){this.stop(),setTimeout(function(){$("#game-ct").hide(),$(".game-over").show()}.bind(this),200)},createFloorSpan:function(){var o=this.__floorScrollerY+=this._floorDeltaY,t=Math.random()*(this._canvasWidth-this._floorWidth),e=['<i class="floor normal"></i>','<i class="floor normal"></i>','<i class="floor spring"></i>','<i class="floor spring"></i>','<i class="floor weak"></i>','<i class="floor weak"></i>','<i class="floor scroll-left"></i>','<i class="floor scroll-right"></i>','<i class="floor nail"></i>','<i class="floor nail"></i>','<i class="floor nail"></i>','<i class="floor nail"></i>'];$(e[Math.floor(Math.random()*e.length)]).css({top:o,left:t,width:this._floorWidth,height:this._floorHeight}).appendTo(this._$scroller)},removeFloorSpan:function(){$(".floor").eq(0).remove(),this._floorScore++,this.updateScore()},updateBlood:function(){for(var o=$(".blood i"),t=0;t<o.length;t++)t<this._blood?o.eq(t).removeClass("lose"):o.eq(t).addClass("lose")},updateScore:function(){$(".floor-count").text(this._floorScore),$(".text-score").text(this._floorScore)},loseBlood:function(){if(!this.__onFloor)return this._blood-=4,this._$people.addClass("danger"),setTimeout(function(){this._$people.removeClass("danger")}.bind(this),300),this._blood<=0?(this._blood=0,this.updateBlood(),void this.gameover()):void this.updateBlood()},addBlood:function(){this.__onFloor||this._blood>=12||(this._blood+=1,this.updateBlood())},floorNormal:function(){this.addBlood()},floorNail:function(){this.loseBlood()},floorWeak:function(o){this.addBlood(),o.addClass("over"),setTimeout(function(){o[0].cross=!0},200)},floorScroll:function(o){this.addBlood(),this.__floorScrollDirection=o},floorScrollEnd:function(){this.__floorScrollDirection=null},floorSpring:function(o){this.__$currentJumpFloor=o,this.jumpStart(),this.addBlood()},jumpStart:function(){this.__jumpMode=!0,this.__tempPeopleSpeed=this._peopleSpeed,this._peopleSpeed=this._peopleSpeed/2},jumpEnd:function(o){this.__jumpMode&&(o&&(this.__$currentJumpFloor[0].cross=!0),this.__currentJumpDistance=0,this.__jumpMode=!1,this._peopleSpeed=this.__tempPeopleSpeed)},people:function(o){var t=this._peopleSpeed/o,e=this._speed/o,r=this._peopleVerticalSpeed/o,l=$(".floor"),s=this._$people.offset();if(s.top>this._canvasHeight)return void this.gameover();for(i=0;i<l.length;i++){var h=l.eq(i).offset(),n=Math.abs(s.top+this._peopleHeight-h.top);if(s.top<=t+e){this.__onFloor=!1,this.jumpEnd(!0),this.loseBlood();break}if(!this.__jumpMode&&!l.eq(i)[0].cross&&n<=t+e&&s.left>h.left-this._peopleWidth&&s.left<h.left+this._floorWidth){this.__currentPeopleY=h.top-this._peopleHeight,l.eq(i).hasClass("normal")&&this.floorNormal(),l.eq(i).hasClass("nail")&&this.floorNail(),l.eq(i).hasClass("spring")&&this.floorSpring(l.eq(i)),l.eq(i).hasClass("weak")&&this.floorWeak(l.eq(i)),l.eq(i).hasClass("scroll-left")&&this.floorScroll("left"),l.eq(i).hasClass("scroll-right")&&this.floorScroll("right"),this.__onFloor=!0;break}i==l.length-1&&(this.__onFloor=!1)}this.__jumpMode&&(this.__currentJumpDistance>=this.__maxJumpDistance?this.jumpEnd():(this.__currentJumpDistance+=t,this.__currentPeopleY-=t+e)),this.__onFloor||this.__jumpMode||(this.floorScrollEnd(),this.__currentPeopleY+=t);var a=r;this._peopleGoLeft&&("left"==this.__floorScrollDirection&&(a*=1.5),"right"==this.__floorScrollDirection&&(a*=.5),this.__currentPeopleVertical>0&&(this.__currentPeopleVertical-=a)),this._peopleGoRight&&("left"==this.__floorScrollDirection&&(a*=.5),"right"==this.__floorScrollDirection&&(a*=1.5),this.__currentPeopleVertical<this._canvasWidth-this._peopleWidth&&(this.__currentPeopleVertical+=a)),this._peopleGoRight||this._peopleGoLeft||(a*=.5,"left"==this.__floorScrollDirection&&this.__currentPeopleVertical>0&&(this.__currentPeopleVertical-=a),"right"==this.__floorScrollDirection&&this.__currentPeopleVertical<this._canvasWidth-this._peopleWidth&&(this.__currentPeopleVertical+=a)),this.peopleUpdateView()},peopleUpdateView:function(){this._$people.css({transform:"translate3d("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px ,0)"})},peopleUserController:function(){var o=this;$(window).keydown(function(t){return"ArrowRight"==t.key?(o._peopleGoRight=!0,void(o._peopleGoLeft=!1)):"ArrowLeft"==t.key?(o._peopleGoRight=!1,void(o._peopleGoLeft=!0)):void 0}).keyup(function(t){return"ArrowRight"==t.key?void(o._peopleGoRight=!1):"ArrowLeft"==t.key?void(o._peopleGoLeft=!1):void 0}),$(".controller .left-ct").on("touchstart",function(t){return o._peopleGoRight=!1,o._peopleGoLeft=!0,!1}).on("touchend",function(t){o._peopleGoLeft=!1}),$(".controller .right-ct").on("touchstart",function(t){return o._peopleGoRight=!0,o._peopleGoLeft=!1,!1}).on("touchend",function(t){o._peopleGoRight=!1})},core:function(o){var t=this,e=this._speed/o;if(this.__currentScrollerY-=e,this.__currentScrollerY<=2*-this._canvasHeight){this.__currentScrollerY+=this._canvasHeight,this.__floorScrollerY-=this._canvasHeight;var r=$(".floor");for(i=0;i<r.length;i++)r.eq(i).css({top:parseInt($(".floor").eq(i).css("top"))-this._canvasHeight})}this._$scroller.css({transform:"translate3d(0, "+t.__currentScrollerY+"px, 0)"}),$(".floor").eq(0).offset().top<=-20&&(this.createFloorSpan(),this.removeFloorSpan()),this.people(o),this._speed<=this._maxSpeed&&(this._speed+=.05)},run:function(o){if(this._animation)return console.log(this._animation),void console.error("Animation has aready in process, please do not run again!");this._fps=o=o||60;var t=1e3/o,e=this;return this._animation=setInterval(function(){e.core(o)},t)},stop:function(){clearInterval(this._animation),this._animation=void 0},reRun:function(){console.log(this.__paramBackup._floorScore),$.extend(this,this.__paramBackup),$(".floor").remove(),this.init(),this.run(60)},backup:function(){this.__paramBackup={};for(i in this)"number"!=typeof this[i]&&"string"!=typeof this[i]||(this.__paramBackup[i]=this[i])},init:function(){var o=0;for(this._canvasWidth=this._$canvas.width(),this._canvasHeight=this._$canvas.height(),this._floorDeltaY=this._canvasHeight/11,this._floorWidth=this._canvasWidth/5,this._floorHeight=this._floorWidth/9,this._peopleHeight=this._$people.height(),this._peopleWidth=this._$people.width(),this.__currentPeopleVertical=this._canvasWidth/2+this._peopleWidth/2,this.backup();o++<13;)this.createFloorSpan();this.peopleUserController(),this.peopleUpdateView(),this.updateBlood(),this.updateScore()}};$(function(){$("#start-game").click(function(){$(".game-intro").hide(),$("#game-ct").show(),gameController.init(),gameController.run(60)}),$("#restart-game").click(function(){$("#game-ct").show(),$(".game-over").hide(),gameController.reRun()})});