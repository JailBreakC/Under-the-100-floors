var gameController={_animation:null,_canvasWidth:0,_canvasHeight:0,_floorWidth:$(".canvas").width()/5,_floorDeltaY:50,_floorAppearRate:[1,1,1,1,1,1],_floorScore:1,_speed:50,_maxSpeed:200,_blood:12,_$canvas:$(".canvas"),_$scroller:$(".scroller"),_$people:$(".people"),_peopleSpeed:180,_peopleVerticalSpeed:150,_peopleHeight:$(".people").height(),_peopleWidth:$(".people").width(),_scrollerHeight:$(".scroller").height(),__currentScrollerY:0,__currentPeopleY:20,__currentPeopleVertical:0,__floorScrollerY:200,__maxJumpDistance:20,__currentJumpDistance:0,__frameIndex:0,gameover:function(){this.stop(),setTimeout(function(){alert("Game Over"),window.location.reload()})},createFloorSpan:function(){var o=this.__floorScrollerY+=this._floorDeltaY,e=Math.random()*(this._canvasWidth-this._floorWidth),t=function(o){for(var e=[],t=0;t<o.length;t++)e[t]=o[t]*Math.random();var i=Math.max.apply(Math,e);return e.indexOf(i)},i=['<i class="floor normal"></i>','<i class="floor spring"></i>','<i class="floor weak"></i>','<i class="floor scroll-left"></i>','<i class="floor scroll-right"></i>','<i class="floor nail"></i>'];$(i[t(this._floorAppearRate)]).css({top:o,left:e,width:this._floorWidth}).appendTo(this._$scroller)},removeFloorSpan:function(){$(".floor").eq(0).remove(),this._floorScore++,$(".floor-count").text(this._floorScore)},updateBlood:function(){var o="★★★★★★★★★★★★☆☆☆☆☆☆☆☆☆☆☆☆";o=o.slice(12-this._blood,24-this._blood),$(".blood").text(o)},loseBlood:function(){if(!this.__onFloor)return this._blood-=4,this._$people.addClass("danger"),setTimeout(function(){this._$people.removeClass("danger")}.bind(this),300),this._blood<=0?(this._blood=0,this.updateBlood(),void this.gameover()):void this.updateBlood()},addBlood:function(){this.__onFloor||this._blood>=12||(this._blood+=1,this.updateBlood())},floorNormal:function(){this.addBlood()},floorNail:function(){this.loseBlood()},floorWeak:function(o){this.addBlood(),o.addClass("over"),setTimeout(function(){o[0].cross=!0},200)},floorScroll:function(o){this.addBlood(),this.__floorScrollDirection=o},floorScrollEnd:function(){this.__floorScrollDirection=null},floorSpring:function(o){this.__$currentJumpFloor=o,this.jumpStart(),this.addBlood()},jumpStart:function(){this.__jumpMode=!0,this.__tempPeopleSpeed=this._peopleSpeed,this._peopleSpeed=this._peopleSpeed/2},jumpEnd:function(o){this.__jumpMode&&(o&&(this.__$currentJumpFloor[0].cross=!0),this.__currentJumpDistance=0,this.__jumpMode=!1,this._peopleSpeed=this.__tempPeopleSpeed)},people:function(o){var e=this._peopleSpeed/o,t=this._speed/o,r=this._peopleVerticalSpeed/o,l=$(".floor"),s=this._$people.offset();if(s.top>this._canvasHeight)return void this.gameover();for(i=0;i<l.length;i++){var n=l.eq(i).offset(),h=Math.abs(s.top+this._peopleHeight-n.top);if(s.top<=e+t){this.__onFloor=!1,this.jumpEnd(!0),this.loseBlood();break}if(!this.__jumpMode&&!l.eq(i)[0].cross&&h<=e+t&&s.left>n.left-this._peopleWidth&&s.left<n.left+this._floorWidth){this.__currentPeopleY=n.top-this._peopleHeight,l.eq(i).hasClass("normal")&&this.floorNormal(),l.eq(i).hasClass("nail")&&this.floorNail(),l.eq(i).hasClass("spring")&&this.floorSpring(l.eq(i)),l.eq(i).hasClass("weak")&&this.floorWeak(l.eq(i)),l.eq(i).hasClass("scroll-left")&&this.floorScroll("left"),l.eq(i).hasClass("scroll-right")&&this.floorScroll("right"),this.__onFloor=!0;break}i==l.length-1&&(this.__onFloor=!1)}this.__jumpMode&&(this.__currentJumpDistance>=this.__maxJumpDistance?this.jumpEnd():(this.__currentJumpDistance+=e,this.__currentPeopleY-=e+t)),this.__onFloor||this.__jumpMode||(this.floorScrollEnd(),this.__currentPeopleY+=e);var a=r;this._peopleGoLeft&&("left"==this.__floorScrollDirection&&(a*=1.5),"right"==this.__floorScrollDirection&&(a*=.5),console.log(this.__floorScrollDirection),this.__currentPeopleVertical>0&&(this.__currentPeopleVertical-=a)),this._peopleGoRight&&("left"==this.__floorScrollDirection&&(a*=.5),"right"==this.__floorScrollDirection&&(a*=1.5),console.log(this.__floorScrollDirection),this.__currentPeopleVertical<this._canvasWidth-this._peopleWidth&&(this.__currentPeopleVertical+=a)),this.peopleUpdateView()},peopleUpdateView:function(){this._$people.css({transform:"translate3d("+this.__currentPeopleVertical+"px , "+this.__currentPeopleY+"px ,0)"})},peopleUserController:function(){var o=this;$(window).keydown(function(e){return"ArrowRight"==e.key?(o._peopleGoRight=!0,void(o._peopleGoLeft=!1)):"ArrowLeft"==e.key?(o._peopleGoRight=!1,void(o._peopleGoLeft=!0)):void 0}).keyup(function(e){return"ArrowRight"==e.key?void(o._peopleGoRight=!1):"ArrowLeft"==e.key?void(o._peopleGoLeft=!1):void 0}),$(".controller .left-ct").on("touchstart",function(e){return o._peopleGoRight=!1,o._peopleGoLeft=!0,!1}).on("touchend",function(e){o._peopleGoLeft=!1}),$(".controller .right-ct").on("touchstart",function(e){return o._peopleGoRight=!0,o._peopleGoLeft=!1,!1}).on("touchend",function(e){o._peopleGoRight=!1})},core:function(o){var e=this,t=this._speed/o;if(this.__currentScrollerY-=t,this.__currentScrollerY<=2*-this._canvasHeight){this.__currentScrollerY+=this._canvasHeight,this.__floorScrollerY-=this._canvasHeight;var r=$(".floor");for(i=0;i<r.length;i++)r.eq(i).css({top:parseInt($(".floor").eq(i).css("top"))-this._canvasHeight})}this._$scroller.css({transform:"translate3d(0, "+e.__currentScrollerY+"px, 0)"}),$(".floor").eq(0).offset().top<=-20&&(this.createFloorSpan(),this.removeFloorSpan()),this.people(o),this._speed<=this._maxSpeed&&(this._speed+=.05)},run:function(o){if(this._animation)return void console.error("Animation has aready in process, please do not run again!");this._fps=o=o||60;var e=1e3/o,t=this;return this._animation=setInterval(function(){t.core(o)},e)},stop:function(){clearInterval(this._animation)},init:function(){var o=this,e=0;for($(window).resize(function(){o._canvasWidth=o._$canvas.width(),o._canvasHeight=o._$canvas.height()}),o._canvasWidth=$(".canvas").width(),o._canvasHeight=o._$canvas.height();e++<13;)this.createFloorSpan();this.peopleUserController(),this.__currentPeopleVertical=this._canvasWidth/2+this._peopleWidth/2,this.peopleUpdateView(),this.updateBlood(),this.run(60)}};$(function(){gameController.init()});